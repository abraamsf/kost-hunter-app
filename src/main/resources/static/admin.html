<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>

    <link rel="icon" href="kost.jpg" type="image/jpg">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    
    <style>
        /* TEMA GELAP UTAMA */
        body { 
            background: radial-gradient(circle at 20% 20%, #0b132b 0%, #000 75%); 
            font-family: 'Open Sans', sans-serif; 
            overflow-x: hidden; 
            color: #e2e8f0; 
        }

        /* SIDEBAR */
        .sidebar { height: 100vh; background: linear-gradient(180deg, #0b132b, #1e293b); color: #adb5bd; position: fixed; width: 250px; padding-top: 30px; z-index: 1000; border-right: 1px solid rgba(58,134,255,0.15); box-shadow: 0 10px 30px rgba(0,180,216,0.2); }
        .sidebar-brand { color: #93c5fd; text-align: center; font-weight: 800; letter-spacing: 1px; margin-bottom: 40px; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .logo-icon { color: #4cc9f0; font-size: 1.5rem; }
        .sidebar a { color: #cbd5e1; padding: 15px 25px; display: block; text-decoration: none; border-left: 4px solid transparent; font-weight: 600; font-size: 0.9rem; }
        .sidebar a:hover, .sidebar a.active { background: rgba(255,255,255,0.05); color: white; border-left-color: #3a86ff; }
        
        /* CONTENT & CARD */
        .content { margin-left: 250px; padding: 40px; }
        .card { 
            border: 1px solid rgba(58,134,255,0.15); 
            border-radius: 8px; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.4); 
            overflow: hidden; 
            background: rgba(15, 23, 42, 0.8); /* Gelap Transparan */
            backdrop-filter: blur(8px); 
            color: #e2e8f0; 
        }

        /* TABLE STYLING (DARK MODE) */
        .table { color: #e2e8f0; }
        .table thead th { 
            background-color: rgba(58, 134, 255, 0.1); 
            border-bottom: 2px solid rgba(58,134,255,0.3); 
            color: #93c5fd; 
            font-size: 0.85rem; 
            text-transform: uppercase; 
            font-weight: 700; 
            border-top: none; 
        }
        .table td { vertical-align: middle; border-top: 1px solid rgba(255,255,255,0.1); }
        .table-hover tbody tr:hover { color: #fff; background-color: rgba(255,255,255,0.05); }

        /* BUTTONS */
        .btn-primary { background: linear-gradient(90deg, #3a86ff, #00b4d8); border: none; font-weight: 600; box-shadow: 0 0 15px rgba(58,134,255,0.5); color: #fff; }
        .btn-primary:hover { transform: translateY(-2px) scale(1.02); box-shadow: 0 0 25px rgba(0,180,216,0.6); background: linear-gradient(90deg, #4cc9f0, #3a86ff); }
        .btn-danger-soft { color: #ff6b6b; background: rgba(220, 53, 69, 0.15); border: none; font-weight: 600; }
        .btn-danger-soft:hover { background: #dc3545; color: white; }
        .btn-warning-soft { color: #feca57; background: rgba(230, 126, 34, 0.15); border: none; font-weight: 600; margin-right: 5px; }
        .btn-warning-soft:hover { background: #e67e22; color: white; }
        
        /* MODAL & FORMS (FIX UNREADABLE TEXT) */
        .modal-content { 
            background-color: #0f172a; 
            border: 1px solid rgba(58,134,255,0.3); 
            color: #e2e8f0; 
        }
        .modal-header { border-bottom: 1px solid rgba(255,255,255,0.1); }
        .modal-footer { border-top: 1px solid rgba(255,255,255,0.1); background-color: rgba(0,0,0,0.2); }
        .close { color: #fff; text-shadow: none; opacity: 1; }
        .close:hover { color: #dc3545; }

        /* INPUT FIELDS DARK MODE */
        .form-control { 
            background-color: rgba(255,255,255,0.05); 
            border: 1px solid rgba(255,255,255,0.2); 
            color: #fff; 
        }
        .form-control:focus { 
            background-color: rgba(255,255,255,0.1); 
            border-color: #3a86ff; 
            color: #fff; 
            box-shadow: none;
        }
        /* Kotak Upload Foto */
        .box-upload {
            background-color: rgba(255,255,255,0.05); 
            border: 1px dashed rgba(255,255,255,0.3);
            border-radius: 8px;
        }

        #mapPicker { height: 300px; width: 100%; border-radius: 4px; border: 2px solid rgba(58,134,255,0.2); margin-top: 5px; margin-bottom: 10px; cursor: crosshair; }
        
        /* Text Utils Overrides */
        .text-dark { color: #e2e8f0 !important; } /* Force dark text classes to be light */
        .text-muted { color: #94a3b8 !important; }

        @media (max-width: 768px) { .sidebar { margin-left: -250px; } .content { margin-left: 0; } }
    </style>
</head>
<body> <div class="sidebar" id="sidebar">
    <div class="sidebar-brand"><i class="fa fa-building logo-icon"></i> KOST HUNTER</div>
    <a href="#" class="active" onclick="switchTab('kost', event)"><i class="fa fa-building mr-2"></i> DATA KOST</a>
    <a href="#" onclick="switchTab('booking', event)"><i class="fa fa-shopping-bag mr-2"></i> PESANAN</a>
    <a href="#" onclick="logout()" class="text-danger mt-5"><i class="fa fa-power-off mr-2"></i> KELUAR</a>
</div>

<div class="content">
    <div id="kostSection">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 class="font-weight-bold mb-0" style="color: #93c5fd;">Daftar Kost Saya</h3>
            <button class="btn btn-primary shadow-sm" onclick="openAddModal()"><i class="fa fa-plus mr-2"></i> Tambah Kost</button>
        </div>
        <div class="card">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead><tr><th>ID</th><th>Nama Kost</th><th>Harga</th><th>Ketersediaan</th><th>Aksi</th></tr></thead>
                    <tbody id="tableKost"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="bookingSection" style="display: none;">
        <h3 class="font-weight-bold mb-4" style="color: #93c5fd;">Pesanan Masuk</h3>
        <div class="card">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead><tr><th>Pelanggan</th><th>Info Kost</th><th>Durasi</th><th>Total</th><th>Aksi</th></tr></thead>
                    <tbody id="tableBooking"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="kostModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title font-weight-bold" id="modalTitle" style="color: #93c5fd;">Input Kost Baru</h5>
                <button type="button" class="close" data-dismiss="modal">Ã—</button>
            </div>
            <div class="modal-body p-4">
                <form id="kostForm">
                    <input type="hidden" id="kId"> 
                    <div class="form-group">
                        <label class="small text-muted font-weight-bold">NAMA KOST</label>
                        <input type="text" id="kName" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="small text-muted font-weight-bold">NO HP PEMILIK</label>
                        <input type="text" id="kPhone" class="form-control" required>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="small text-muted font-weight-bold">HARGA (RP)</label>
                                <input type="number" id="kPrice" class="form-control" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="small text-muted font-weight-bold">KETERSEDIAAN KAMAR</label>
                                <input type="number" id="kAvail" class="form-control" min="0" required>
                            </div>
                        </div>
                    </div>

                    <div class="p-3 mb-3 box-upload">
                        <h6 class="text-primary font-weight-bold small">FOTO KOST</h6>
                        <div class="form-group">
                            <label class="small">Upload File:</label>
                            <input type="file" id="kFiles" class="form-control-file text-white" multiple accept="image/*" onchange="previewImages()">
                            <div id="imagePreview" class="d-flex flex-wrap mt-2"></div>
                        </div>
                        <div class="form-group">
                            <label class="small">Atau URL:</label>
                            <input type="text" id="kUrlImage" class="form-control" placeholder="https://...">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="small text-muted font-weight-bold">FASILITAS</label>
                        <input type="text" id="kFacilities" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="small text-muted font-weight-bold">DESKRIPSI</label>
                        <textarea id="kDesc" class="form-control" rows="2" required></textarea>
                    </div>
                    <hr style="border-top: 1px solid rgba(255,255,255,0.1);">
                    <label class="small text-primary font-weight-bold mb-2">LOKASI (GESER PIN)</label>
                    <div id="mapPicker"></div>
                    <div class="row mt-2">
                        <div class="col-6"><input type="text" id="kLat" class="form-control form-control-sm" readonly></div>
                        <div class="col-6"><input type="text" id="kLng" class="form-control form-control-sm" readonly></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-dismiss="modal">Batal</button>
                <button class="btn btn-primary" onclick="submitKost()">Simpan Data</button>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    const user = JSON.parse(localStorage.getItem('user'));
    if (!user || user.role !== 'ADMIN') window.location.href = 'login.html';

    let mapPicker, marker;
    let isEditMode = false; // Status Mode

    // --- 1. LOAD DAFTAR KOST (DENGAN TOMBOL EDIT) ---
    async function loadKosts() {
        try {
            const res = await fetch(`/api/kosts?ownerId=${user.id}`);
            const data = await res.json();
            let html = '';
            if(data.length === 0) html = '<tr><td colspan="5" class="text-center p-4">Belum ada kost.</td></tr>';
            else {
                data.forEach(k => {
                    html += `<tr>
                        <td>#${k.id}</td>
                        <td><b>${k.name}</b></td>
                        <td>Rp ${k.price.toLocaleString('id-ID')}</td>
                        <td>${k.availableRooms ?? 0}</td>
                        <td>
                            <button class="btn btn-sm btn-warning-soft" onclick="openEditModal(${k.id})">
                                <i class="fa fa-pencil"></i> Edit
                            </button>
                            <button class="btn btn-sm btn-danger-soft" onclick="deleteKost(${k.id})">
                                <i class="fa fa-trash"></i> Hapus
                            </button>
                        </td>
                    </tr>`;
                });
            }
            document.getElementById('tableKost').innerHTML = html;
        } catch(e){}
    }

    // --- 2. BUKA MODAL TAMBAH (RESET) ---
    function openAddModal() {
        isEditMode = false;
        $('#modalTitle').text("Tambah Kost Baru");
        document.getElementById('kostForm').reset();
        document.getElementById('kId').value = "";
        document.getElementById('imagePreview').innerHTML = ""; 
        $('#kostModal').modal('show');
        setTimeout(() => initMapPicker(-6.917, 107.619), 500); // Default Bandung
    }

    // --- 3. BUKA MODAL EDIT (ISI DATA LAMA) ---
    async function openEditModal(id) {
        isEditMode = true;
        $('#modalTitle').text("Edit Data Kost");
        document.getElementById('imagePreview').innerHTML = ""; // Bersihkan preview

        try {
            const res = await fetch(`/api/kosts/${id}`);
            const k = await res.json();
            
            // Isi Form
            document.getElementById('kId').value = k.id;
            document.getElementById('kName').value = k.name;
            document.getElementById('kPrice').value = k.price;
            document.getElementById('kAvail').value = k.availableRooms ?? 0;
            document.getElementById('kPhone').value = k.ownerPhone;
            document.getElementById('kFacilities').value = k.facilities;
            document.getElementById('kDesc').value = k.description;
            
            // Tampilkan Lokasi di Peta
            $('#kostModal').modal('show');
            setTimeout(() => initMapPicker(k.latitude || -6.917, k.longitude || 107.619), 500);

        } catch(e) { alert("Gagal mengambil data"); }
    }

    // --- 4. SUBMIT DATA (CREATE / UPDATE) ---
    async function submitKost() {
        const id = document.getElementById('kId').value;
        const formData = new FormData();
        
        formData.append('name', document.getElementById('kName').value);
        formData.append('price', document.getElementById('kPrice').value);
        formData.append('description', document.getElementById('kDesc').value);
        formData.append('facilities', document.getElementById('kFacilities').value);
        formData.append('latitude', document.getElementById('kLat').value);
        formData.append('longitude', document.getElementById('kLng').value);
        formData.append('ownerName', user.name);
        formData.append('ownerPhone', document.getElementById('kPhone').value);
        formData.append('ownerId', user.id);
        formData.append('availableRooms', document.getElementById('kAvail').value);

        const urlImage = document.getElementById('kUrlImage').value;
        if(urlImage) formData.append('urlImages', urlImage);

        const fileInput = document.getElementById('kFiles');
        for (let i = 0; i < fileInput.files.length; i++) {
            formData.append('fileImages', fileInput.files[i]);
        }

        let url = '/api/kosts';
        if (isEditMode) {
            url = `/api/kosts/${id}`;
        }

        try {
            const res = await fetch(url, { 
                method: isEditMode ? 'PUT' : 'POST', 
                body: formData 
            });

            if (res.ok) {
                alert(isEditMode ? "Data Berhasil Diupdate!" : "Data Berhasil Disimpan!");
                $('#kostModal').modal('hide');
                loadKosts();
            } else {
                alert("Gagal menyimpan data.");
            }
        } catch(err) { console.error(err); alert("Error Server"); }
    }

    // --- HELPER LAINNYA ---
    function previewImages() {
        const container = document.getElementById('imagePreview');
        container.innerHTML = '';
        const files = document.getElementById('kFiles').files;
        for (let i = 0; i < files.length; i++) {
            const img = document.createElement('img');
            img.src = URL.createObjectURL(files[i]);
            img.className = 'img-thumbnail mr-2 mb-2';
            img.style.cssText = 'height:80px; width:80px; object-fit:cover; background:transparent; border:1px solid #555;';
            container.appendChild(img);
        }
    }

    function initMapPicker(lat, lng) {
        if (!mapPicker) {
            mapPicker = L.map('mapPicker').setView([lat, lng], 13);
            L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(mapPicker);
            marker = L.marker([lat, lng], {draggable: true}).addTo(mapPicker);
            marker.on('dragend', function(e) { let pos = marker.getLatLng(); updateInputs(pos.lat, pos.lng); });
            mapPicker.on('click', function(e) { marker.setLatLng(e.latlng); updateInputs(e.latlng.lat, e.latlng.lng); });
        } else {
            mapPicker.setView([lat, lng], 13);
            marker.setLatLng([lat, lng]);
        }
        mapPicker.invalidateSize();
        updateInputs(lat, lng);
    }
    function updateInputs(lat, lng) { document.getElementById('kLat').value = lat; document.getElementById('kLng').value = lng; }

    async function loadBookings() { 
        try {
            const res = await fetch(`/api/bookings?ownerId=${user.id}`);
            const data = await res.json();
            let html = '';
            if(data.length===0) html='<tr><td colspan="5" class="text-center p-4">Belum ada pesanan.</td></tr>';
            else data.forEach(b => { 
                html += `<tr>
                    <td><b>${b.customerName}</b><br><small class="text-muted">${b.customerEmail}</small></td>
                    <td>${b.kostName}</td>
                    <td>${b.durationInMonths} Bln</td>
                    <td class="font-weight-bold" style="color: #4cd137;">Rp ${b.totalPrice.toLocaleString('id-ID')}</td>
                    <td><button class="btn btn-sm btn-danger-soft" onclick="deleteBooking(${b.id})"><i class="fa fa-trash"></i></button></td>
                </tr>`; 
            });
            document.getElementById('tableBooking').innerHTML = html;
        } catch(e){}
    }

    async function deleteBooking(id) { if(confirm("Hapus?")) { await fetch(`/api/bookings/${id}`, {method:'DELETE'}); loadBookings(); }}
    async function deleteKost(id) { if(confirm("Hapus?")) { await fetch(`/api/kosts/${id}`, {method:'DELETE'}); loadKosts(); }}

    function switchTab(tab, e) {
        $('.sidebar a').removeClass('active'); $(e.target).addClass('active');
        if(tab==='kost'){ $('#kostSection').show(); $('#bookingSection').hide(); loadKosts(); }
        else { $('#kostSection').hide(); $('#bookingSection').show(); loadBookings(); }
    }
    function logout() { localStorage.clear(); window.location.href='login.html'; }
    
    loadKosts();
</script>
</body>
</html>